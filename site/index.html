<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Qieyun</title>
    <script type="module">
      import TshetUinh from 'https://cdn.jsdelivr.net/npm/tshet-uinh@0.16.0-beta.2/dist/tshet-uinh.esm.min.js';
      import { createApp, onMounted, ref } from 'https://cdn.jsdelivr.net/npm/vue@3/dist/vue.esm-browser.js';

      const [小韻目錄, 所在卷] = (function get全韻目小韻() {
        const 小韻目錄 = {};
        const 所在卷 = {};
        const 卷首韻目 = { 東: '上平', 先: '下平', 董: '上', 送: '去', 屋: '入' };
        let 卷;
        let 卷內目錄;
        let 韻;
        let 韻內目錄;
        let 原書小韻號 = 0;
        for (const 小韻 of TshetUinh.資料.廣韻.iter原書小韻()) {
          原書小韻號++;
          const { 韻目: 小韻韻目 } = 小韻[0];
          if (小韻韻目 !== 韻) {
            if (小韻韻目 in 卷首韻目) {
              卷 = 卷首韻目[小韻韻目];
              卷內目錄 = {};
              小韻目錄[卷] = 卷內目錄;
            }
            韻 = 小韻韻目;
            韻內目錄 = [];
            卷內目錄[韻] = 韻內目錄;
            所在卷[韻] = 卷;
          }
          韻內目錄.push([原書小韻號, 小韻[0]]);
        }
        return [小韻目錄, 所在卷];
      })();

      const tupaTable = JSON.parse(await (fetch('tupa.json').then(x => x.text())));

      function keyForEntry(條目) {
        return `${條目.來源}/${條目.小韻號}/${條目.小韻字號}`;
      }

      const Entry = {
        props: ['條目'],
        computed: {
          showDebug: () => false,
          tupaTable: () => tupaTable,
        },
        template: '#template-entry',
      };

      const RhymeList = {
        setup(_props, { emit }) {
          const showing卷 = ref('上平');
          const showing韻 = ref('東');
          const selected原書小韻號 = ref(1);

          function onClick卷(卷) {
            showing卷.value = 卷;
            for (const 韻 in 小韻目錄[卷]) {
              showing韻.value = 韻;
              break;
            }
          }

          function onClick小韻(原書小韻號) {
            selected原書小韻號.value = 原書小韻號;
            emit('query', 原書小韻號);
          }

          function select(原書小韻號) {
            selected原書小韻號.value = 原書小韻號;
            showing韻.value = TshetUinh.資料.廣韻.get原書小韻(原書小韻號)?.[0].韻目 ?? '東';
            showing卷.value = 所在卷[showing韻.value];
          }

          return {
            showing卷,
            showing韻,
            selected原書小韻號,
            onClick卷,
            onClick小韻,
            select,
          };
        },
        computed: {
          小韻目錄: () => 小韻目錄,
        },
        template: '#template-rhyme-list',
      };

      const App = {
        components: {
          Entry,
          RhymeList,
        },
        emits: ['query'],
        setup() {
          const input = ref('');
          const result = ref([]);

          const rhymeList = ref(null);

          function queryRawResult(query) {
            if (query.startsWith('@')) {
              const 原書小韻號 = Number(query.slice(1));
              rhymeList.value.select(原書小韻號);
              return TshetUinh.資料.廣韻.get原書小韻(原書小韻號) ?? [];
            }
            return TshetUinh.資料.query字頭(query);
          }

          function doQuery(query, fromUrl = false) {
            query = query ?? input.value;

            input.value = query;
            const url = new URL(location);
            url.search = '';
            if (query) {
              url.searchParams.set('q', query);
            }
            if (fromUrl) {
              history.replaceState(null, '', url);
            } else {
              history.pushState(null, '', url);
            }

            const rawResult = queryRawResult(query);
            const expanded = [];
            const seen = new Set();
            for (const 條目 of rawResult) {
              const key = keyForEntry(條目);
              if (seen.has(key)) {
                continue;
              }
              if (!條目.釋義上下文) {
                expanded.push(條目);
                continue;
              }
              for (const 上下文條目 of 條目.釋義上下文) {
                const 展開條目 = Object.assign(Object.create(Object.getPrototypeOf(條目)), 條目, 上下文條目);
                seen.add(keyForEntry(展開條目));
                expanded.push(展開條目);
              }
            }
            result.value = expanded;
          }

          onMounted(() => {
            const queryFromUrl = () => {
              const url = new URL(location);
              doQuery(url.searchParams.get('q') ?? '', true);
            };
            window.addEventListener('popstate', queryFromUrl);
            queryFromUrl();
          });

          return {
            input,
            result,
            rhymeList,
            doQuery,
            keyForEntry,
          };
        },
        template: '#template-app',
      };

      createApp(App).mount('#app');
    </script>

    <template id="template-app">
      <form @submit.prevent="doQuery()">
        <input type="text" v-model.trim="input" />
        <input type="submit" value="查詢" />
      </form>
      <rhyme-list ref="rhymeList" @query="(原書小韻號) => doQuery('@' + 原書小韻號)"></rhyme-list>
      <ul>
        <li v-for="條目 in result" :key="keyForEntry(條目)">
          <entry :條目="條目"></entry>
        </li>
      </ul>
    </template>

    <template id="template-rhyme-list">
      <div class="rhyme-list">
        <div class="row">
          卷：<span
            v-for="(, 卷) in 小韻目錄"
            class="tab-item"
            :class="{ current: 卷 === showing卷 }"
            @click="onClick卷(卷)"
          >{{ 卷 }}</span>
        </div>
        <div class="row">
          韻：<span
            v-for="(, 韻) in 小韻目錄[showing卷]"
            class="tab-item"
            :class="{ current: 韻 === showing韻 }"
            @click="showing韻 = 韻"
          >{{ 韻 }}</span>
        </div>
        <div class="row">
          小韻：<span
            v-for="[原書小韻號, 首字] in 小韻目錄[showing卷][showing韻]"
            class="item"
            :class="{ current: 原書小韻號 === selected原書小韻號 }"
            @click="onClick小韻(原書小韻號)"
          >{{ 首字.字頭 }}</span>
        </div>
      </div>
    </template>

    <template id="template-entry">
      <article class="result-item">
        <p>
          <span class="headword">{{ 條目.字頭 }}</span>
          <span class="pronunciation position">{{ 條目.音韻地位.描述 }}</span>
          <span class="pronunciation tupa">{{ tupaTable[條目.音韻地位.描述] }}</span>
          <span v-if="條目.反切" class="pronunciation fanqie"
          >{{ 條目.反切 ? (條目.反切 + (條目.來源 === '廣韻' ? '切': '反')) : ''}}</span>
          <span v-if="條目.直音" class="pronunciation zhiyin">音{{ 條目.直音 }}</span>
        </p>
        <p v-if="條目.字頭說明" class="headword-note">{{ 條目.字頭說明 }}</p>
        <p v-if="條目.釋義" class="note">{{ 條目.釋義 }}</p>
        <p class="cite">
          {{條目.來源}} {{條目.韻目}}韻
        </p>
        <p v-if="showDebug" style="color: darkgray">{{ 條目 }}</p>
      </article>
    </template>

    <style>
      .rhyme-list .row {
        margin: 0.5rem 0;
        display: flex;
        flex-wrap: wrap;
      }
      .rhyme-list :is(.tab-item, .item) {
        padding: 0 0.1rem;
        margin: 0.1rem 0;
        margin-right: -1px;
        border: 1px solid #dfdfdf;
        --border-color: #484848;
      }
      .rhyme-list .current {
        position: relative;
        z-index: 1;
        font-weight: 700;
      }
      .rhyme-list .tab-item {
        border-bottom-color: var(--border-color);
      }
      .rhyme-list .tab-item.current {
        border-color: var(--border-color);
        border-bottom-color: transparent;
      }
      .rhyme-list .item.current {
        border-color: var(--border-color);
      }

      .result-item {
        padding: 1em 0;
      }
      .result-item p {
        margin: 0.3em 0;
      }
      .result-item .headword {
        font-size: 2rem;
        line-height: 0;
        margin-right: 0.5rem;
      }
      .result-item .headword-note {
        font-size: 0.75rem;
      }
      .result-item .pronunciation {
        margin-left: 0.5rem;
      }
      .tupa {
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div>載入中……</div>
    </div>
  </body>
</html>
